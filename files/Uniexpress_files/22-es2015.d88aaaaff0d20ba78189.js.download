(window.webpackJsonp=window.webpackJsonp||[]).push([[22],{Lsy9:function(t,e,o){"use strict";o.d(e,"a",(function(){return u}));var n=o("M0ag"),i=o("8Y7J"),r=o("6ojV"),s=o("otht"),a=o("I2LU");let u=(()=>{class t extends n.SettingsManager{constructor(t,e){super(t,e)}getDetailTemplateType(t){try{switch(this._getString(this.getSections(t),"template",null)){case"GBCouponDetailTemplateTypeClassic":return n.CouponingDetailTemplateType.Banner;case"GBCouponDetailTemplateTypeMinimal":return n.CouponingDetailTemplateType.Minimal;default:return n.CouponingDetailTemplateType.Banner}}catch(e){return this._logger.warning(`Cannot instanciate detail template for section ${t}`),n.CouponingDetailTemplateType.Banner}}getListTemplateType(t){try{switch(this._getString(this.getSections(t),"template",null)){case"GBCouponListTemplateTypeVisual":return n.CouponingListTemplateType.Visual;case"GBCouponListTemplateTypeClassic":return n.CouponingListTemplateType.Classic;case"GBCouponListTemplateTypeMinimal":return n.CouponingListTemplateType.Minimal;default:return n.CouponingListTemplateType.Visual}}catch(e){return this._logger.warning(`Cannot instanciate list template for section ${t}`),n.CouponingListTemplateType.Classic}}getCouponingSectionId(){let t=this.getSections();for(let e in t)if("GBModuleTypeCouponing"===this.getSectionsType(e))return e;return null}getDaysUntilStart(t){return this._getNumber(this.getSections(t),"daysUntilStart",0)}getCouponingSorting(t,e){return this._getString(this.getSectionsSubsections(t,e),"order","datestart")}getActionButtonBackgroundColor(t){return this.getColor(this.getSections(t),"actionButtonBackgroundColor","#FFFFFF","buttonBackgroundColor")}getActionButtonBackgroundColorGradient(t){return this.getBackgroundColorGradient(this.getSections(t),"actionButtonBackgroundColorGradient",null,"buttonBackgroundColorGradient")}getActionButtonColor(t){return this.getColor(this.getSections(t),"actionButtonColor",this.getGeneralNavBarBackgroundColor(),"buttonTextColor")}getSectionsShowDistance(t){return this._getBoolean(this.getSections(t),"showDistance",!0)}getDetailValidationButtonBackgroundColor(t){return this.getColor(this.getDetailValidationButton(t),"backgroundColor","#FFFFFF","buttonBackgroundColor")}getDetailValidationButtonBackgroundColorGradient(t){return this.getBackgroundColorGradient(this.getDetailValidationButton(t),"backgroundColorGradient",null,"buttonBackgroundColorGradient")}getDetailValidationButtonColor(t){return this.getColor(this.getDetailValidationButton(t),"color","#FFFFFF","buttonTextColor")}getDetailPlaceTitleFont(t){return this.getFont(this.getDetailPlace(t),"titleFont",null,"primary1Color")}getDetailPlaceSubtitleFont(t){return this.getFont(this.getDetailPlace(t),"subtitleFont",null,"primary3Color")}getSavedListBackgroundColor(t){return this.getColor(this.getSectionsSaved(t),"listBackgroundColor","transparent","primary4Color")}getSavedListBackgroundOpacity(t){return this._getNumber(this.getSectionsSaved(t),"listBackgroundOpacity",1)}getSavedShowInfos(t){return this._getBoolean(this.getSectionsSaved(t),"showInfos",!0)}getSavedShowThumb(t){return this._getBoolean(this.getSectionsSaved(t),"showThumb",!0)}getSavedShowDistance(t){return this._getBoolean(this.getSectionsSaved(t),"showDistance",!0)}getSavedInfosContentType(t,e){return this._getString(this.getSectionsSaved(t),"infosContentType",e)}getSavedTitleFont(t){return this.getFont(this.getSectionsSaved(t),"titleFont",null,"primary2Color")}getSavedSubtitleFont(t){return this.getFont(this.getSectionsSaved(t),"subtitleFont",null,"primary1Color")}getSavedInfosFont(t){return this.getFont(this.getSectionsSaved(t),"infosFont",null,"primary3Color")}getSavedPageTitle(t){return this._getString(this.getSectionsSaved(t),"pageTitle",null)}getSavedPageTitleFont(t){return this.getFont(this.getSectionsSaved(t),"pageTitleFont",null,"primary3Color")}getHistoryListBackgroundColor(t){return this.getColor(this.getSectionsHistory(t),"listBackgroundColor","transparent","primary4Color")}getHistoryListBackgroundOpacity(t){return this._getNumber(this.getSectionsHistory(t),"listBackgroundOpacity",1)}getHistoryShowInfos(t){return this._getBoolean(this.getSectionsHistory(t),"showInfos",!0)}getHistoryShowThumb(t){return this._getBoolean(this.getSectionsHistory(t),"showThumb",!0)}getHistoryShowDistance(t){return this._getBoolean(this.getSectionsHistory(t),"showDistance",!0)}getHistoryInfosContentType(t,e){return this._getString(this.getSectionsHistory(t),"infosContentType",e)}getHistoryTitleFont(t){return this.getFont(this.getSectionsHistory(t),"titleFont",null,"primary2Color")}getHistorySubtitleFont(t){return this.getFont(this.getSectionsHistory(t),"subtitleFont",null,"primary1Color")}getHistoryInfosFont(t){return this.getFont(this.getSectionsHistory(t),"infosFont",null,"primary3Color")}getHistoryPageTitle(t){return this._getString(this.getSectionsHistory(t),"pageTitle",null)}getHistoryPageTitleFont(t){return this.getFont(this.getSectionsHistory(t),"pageTitleFont",null,"primary3Color")}getDetailValidationButton(t){return this._getObject(this.getSectionsDetail(t),"validationButton")}getDetailPlace(t){return this._getObject(this.getSectionsDetail(t),"place")}getSectionsSaved(t){return this._getObject(this.getSections(t),"saved")}getSectionsHistory(t){return this._getObject(this.getSections(t),"historical")}}return t.ngInjectableDef=i.Rb({factory:function(){return l(i.Sb(r.a),i.Sb(s.a),i.Sb(a.a))},token:t,providedIn:"root"}),t})();function l(t,e,o){let n=new u(e,o);return n.settings=t.settings,n}},"ukY+":function(t,e,o){"use strict";var n=o("8Y7J"),i=o("z6cu"),r=o("bOdf"),s=o("lJxs"),a=o("JIr8"),u=o("M0ag"),l=o("jGGy"),g=o("LRne"),c=o("wd/R"),h=o("IheW");let p=(()=>{class t{constructor(t,e,o){this.settingsManager=t,this.http=e,this.logger=o,this.setDefaultBaseUrl()}getAllActiveCoupons(t,e,o,n,i){const r=`${this._baseUrl}/coupons/`;let s=new h.i;return e&&(s=s.set("page",e.toString())),t&&(s=s.set("sort",t)),o&&(s=s.set("until_start",o.toString())),n&&(s=(s=s.set("lat",n.coords.latitude.toString())).set("lng",n.coords.longitude.toString())),i&&"[ALL]"!==i&&(s=s.set("categories",`[${i}]`)),this.request(r,s,0)}getAllAvailableCoupons(t,e,o,n,i,r){const s=`${this._baseUrl}/coupons/available/`;let a=new h.i({encoder:new u.GBUrlEncoder});a=a.set("user_id",t.unformattedId),o&&(a=a.set("page",o.toString())),e&&(a=a.set("sort",e)),n&&(a=a.set("until_start",n.toString())),i&&(a=(a=a.set("lat",i.coords.latitude.toString())).set("lng",i.coords.longitude.toString())),r&&"[ALL]"!==r&&(a=a.set("categories",`[${r}]`));let l=c().millisecond(0).toISOString(!0);return l=l.replace(".000",""),a=a.set("user_time",l),this.request(s,a,0)}getCouponDetail(t){const e=`${this._baseUrl}/coupon/details/`;let o=new h.i;return o=o.set("coupon_id",t.toString()),this.request(e,o,0)}getSavedCoupons(t,e,o){const n=`${this._baseUrl}/coupons/favorite/`;let i=new h.i;return i=i.set("user_id",t.unformattedId),e&&(i=i.set("page",e.toString())),o&&(i=(i=i.set("lat",o.coords.latitude.toString())).set("lng",o.coords.longitude.toString())),this.request(n,i,0)}getRedeemedCoupons(t,e){const o=`${this._baseUrl}/coupons/redeemed/`;let n=new h.i;return n=n.set("user_id",t.unformattedId),e&&(n=n.set("page",e.toString())),this.request(o,n,0)}addCouponToFavorites(t,e){const o=`${this._baseUrl}/coupon/favorite/`;let n=new h.i;return n=(n=n.set("user_id",t.unformattedId)).set("coupon_id",e.toString()),this.request(o,n,1)}removeCouponFromFavorites(t,e){const o=`${this._baseUrl}/coupon/not_favorite/`;let n=new h.i;return n=(n=n.set("user_id",t.unformattedId)).set("coupon_id",e.toString()),this.request(o,n,1)}redeemCoupon(t,e){const o=`${this._baseUrl}/coupon/redeem/`;let n=new h.i;return n=(n=n.set("user_id",t.unformattedId)).set("coupon_id",e.toString()),this.request(o,n,1)}setDefaultBaseUrl(){this._baseUrl=t.BASEURL,this.logger.info(`Couponing Api Base Url: ${this._baseUrl}`)}request(e,o,n){const r=this.settingsManager.getIdWebzine();if(!r)throw new Error("Missing Webzine Id");if(o=o.set("webzine_id",r.toString()),0===n)return this.http.get(e,{params:o}).pipe(Object(s.a)(t=>(this.logger.debug("Couponing API Service response",t),new u.JsonObject(t))),Object(a.a)(e=>{let o=new u.JsonObject(e.error);return o.setBoolean(u.IS_GONE_FISHING_KEY,e.status===t.GONE_FISHING_STATUS_CODE),Object(i.a)(o)}));if(1===n){let n=new h.h;return n=n.append("Content-Type","application/x-www-form-urlencoded"),this.http.post(e,o.toString(),{headers:n}).pipe(Object(s.a)(t=>(this.logger.debug("Couponing API Service response",t),new u.JsonObject(t))),Object(a.a)(e=>{let o=new u.JsonObject(e.error);return o.setBoolean(u.IS_GONE_FISHING_KEY,e.status===t.GONE_FISHING_STATUS_CODE),Object(i.a)(o)}))}throw new Error("Missing Method")}}return t.BASEURL="https://api.goodbarber.net/couponapi",t.GONE_FISHING_STATUS_CODE=410,t})(),d=(()=>{class t extends p{constructor(t,e,o){super(t,e,o),this.savedCoupons=new Set}getAllAvailableCoupons(t,e,o,n,i,r){return this.getAllActiveCoupons(e,o,n,i,r)}getSavedCoupons(e,o,n){return this.getAllActiveCoupons(null,o,null,n).pipe(Object(s.a)(e=>{let o=e.getArray(t.RESULT).map(t=>new u.JsonObject(t)).filter(t=>this.savedCoupons.has(t.getNumber("id"))),n={stat:"ok",result:new Array};return o.length>0&&(n.result=o.map(t=>t.object)),new u.JsonObject(n)}))}getRedeemedCoupons(e,o){return this.getAllActiveCoupons(null,o).pipe(Object(s.a)(e=>{const o=e.getArray(t.RESULT);return e.object[t.RESULT]=o.map(t=>(t.last_redeem_date=c(),t)),e}))}addCouponToFavorites(t,e){return this.savedCoupons.add(e),Object(g.a)(new u.JsonObject({stat:"ok"}))}removeCouponFromFavorites(t,e){return this.savedCoupons.delete(e),Object(g.a)(new u.JsonObject({stat:"ok"}))}redeemCoupon(t,e){throw new Error("not implemented in preview")}}return t.RESULT="result",t})();var C=o("Iurr"),S=o("6ojV"),b=o("I2LU");let m=(()=>{class t{}return t.ngInjectableDef=n.Rb({factory:function(){return t=n.Sb(C.f),e=n.Sb(h.c),o=n.Sb(S.a),i=n.Sb(b.a),t.mockData?new d(o,e,i):new p(o,e,i);var t,e,o,i},token:t,providedIn:"root"}),t})();var v=o("0Bcz"),w=o("Lsy9"),T=o("HwWV"),y=o("b/2F");o.d(e,"a",(function(){return f}));let f=(()=>{class t{constructor(t,e,o,n,i,r,s){this.authService=t,this.couponingApi=e,this.itemFactory=o,this.settingsManager=n,this.logger=i,this.geolocator=r,this.platform=s,this.flushCache()}getCoupons(t,e,o=1,n=!0){return this.authService.loggedIn.pipe(Object(r.a)(i=>i?this.getAllAvailableCoupons(t,e,o,n):this.getAllActiveCoupons(t,e,o,n)),Object(s.a)(t=>(t.coupons=t.coupons.filter(t=>t.isAvailable),t)))}getSavedCoupons(e=1,o=!0){let i=this.getCachedData("savedCoupons");if(o&&i){let t=new n.m;return this.logger.debug("Got data from cache :",{response:i}),setTimeout(()=>{t.emit(i)}),t}return this.geolocator.getCurrentPosition().pipe(Object(r.a)(t=>this.couponingApi.getSavedCoupons(this.authService.authenticatedUser,e,t)),Object(a.a)(t=>this.couponingApi.getSavedCoupons(this.authService.authenticatedUser,e)),Object(s.a)(o=>{if(this.logger.debug("Response received :",{response:o}),o.getString(t.ERROR))throw new Error;{let n=o.getArray(t.RESULT).map(t=>{let e=this.itemFactory.createCoupon(new u.JsonObject(t));return this.setCachedData(`coupon-favorite-${e.id}`,!0),e}).filter(t=>t.isAvailable),i=o.getNumber(t.NEXT_PAGE),r=new u.GBCouponContainer(n,i);return 1===e?this.setCachedData("savedCoupons",r):this.mergeCachedData("savedCoupons",r),r}}))}getRedeemedCoupons(e=1,o=!0){let i=this.getCachedData("redeemedCoupons");if(o&&i){let t=new n.m;return this.logger.debug("Got data from cache :",{response:i}),setTimeout(()=>{t.emit(i)}),t}return this.couponingApi.getRedeemedCoupons(this.authService.authenticatedUser,e).pipe(Object(s.a)(o=>{if(this.logger.debug("Response received :",{response:o}),o.getString(t.ERROR))throw new Error;{let n=o.getArray(t.RESULT).map(t=>this.itemFactory.createCoupon(new u.JsonObject(t))),i=o.getNumber(t.NEXT_PAGE),r=new u.GBCouponContainer(n,i);return 1===e?this.setCachedData("redeemedCoupons",r):this.mergeCachedData("redeemedCoupons",r),r}}))}getCouponById(e){let o=`coupon-${e}`,i=this.getCachedData(o);if(i){let t=new n.m;return this.logger.debug("Got data from cache :",{response:i}),setTimeout(()=>{t.emit(i)}),t}return this.couponingApi.getCouponDetail(e).pipe(Object(s.a)(e=>{if(this.logger.debug("Response received :",{response:e}),e.getString(t.ERROR))throw new Error;{let n=e.getJsonObject(t.RESULT),i=this.itemFactory.createCoupon(n);return this.setCachedData(o,i),i}}))}isCouponFavorite(t){let e=new n.m,o=`coupon-favorite-${t}`,i=this.getCachedData(o);return null!=i?setTimeout(()=>{e.emit(i),e.complete()}):this.getSavedCoupons().subscribe(n=>{let i=n.coupons.some(e=>e.id===t);this.setCachedData(o,i),setTimeout(()=>{e.emit(i),e.complete()})}),e}changeFavoriteState(t,e){return this.setCachedData("savedCoupons",null),e?this.removeCouponFromFavorites(t):this.addCouponToFavorites(t)}addCouponToFavorites(e){const o=`coupon-favorite-${e}`;return this.authService.loggedIn.pipe(Object(r.a)(n=>n?this.couponingApi.addCouponToFavorites(this.authService.authenticatedUser,e).pipe(Object(s.a)(e=>{if(this.logger.debug("Response received :",{response:e}),e.getString(t.ERROR))throw new Error;return this.setCachedData(o,!0),!0}),Object(a.a)(t=>Object(i.a)(t))):Object(i.a)("User not logged in")))}removeCouponFromFavorites(e){const o=`coupon-favorite-${e}`;return this.couponingApi.removeCouponFromFavorites(this.authService.authenticatedUser,e).pipe(Object(s.a)(e=>{if(this.logger.debug("Response received :",{response:e}),e.getString(t.ERROR))throw new Error;return this.setCachedData(o,!1),!1}))}redeemCoupon(e){let o=`coupon-${e}`;return this.couponingApi.redeemCoupon(this.authService.authenticatedUser,e).pipe(Object(s.a)(e=>{if(this.logger.debug("Response received :",{response:e}),e.getString(t.ERROR))throw new Error;{let n=e.getJsonObject(t.RESULT),i=this.itemFactory.createCoupon(n);return this.setCachedData(o,i),this.setCachedData("allActiveCoupons",null),this.setCachedData("allAvailableCoupons",null),this.setCachedData("redeemedCoupons",null),i}}))}flushCache(){t._cache.clear()}getAllActiveCoupons(e,o,i,l=!0){const g=`allActiveCoupons-${e}-${o}`;let c=this.getCachedData(g);if(l&&c){let t=new n.m;return this.logger.debug("[getAllActiveCoupons] Got data from cache :",{response:c}),setTimeout(()=>{t.emit(c)}),t}{const n=this.settingsManager.getCouponingSorting(e,o),l=this.settingsManager.getDaysUntilStart(e),c=this.settingsManager.getSectionsSubsectionsIds(e,o);return this.geolocator.getCurrentPosition().pipe(Object(r.a)(t=>this.couponingApi.getAllActiveCoupons(n,i,l,t,c)),Object(a.a)(t=>this.couponingApi.getAllActiveCoupons(n,i,l,null,c)),Object(s.a)(e=>{if(this.logger.debug("Response received :",{response:e}),e.getString(t.ERROR))throw new Error;{let o=e.getArray(t.RESULT).map(t=>{let e=this.itemFactory.createCoupon(new u.JsonObject(t));return this.setCachedData(`coupon-${e.id}`,e),e}),n=e.getNumber(t.NEXT_PAGE),r=new u.GBCouponContainer(o,n);return 1===i?this.setCachedData(g,r):this.mergeCachedData(g,r),r}}))}}getAllAvailableCoupons(e,o,i,l=!0){const g=`allAvailableCoupons-${e}-${o}`;let c=this.getCachedData(g);if(l&&c){let t=new n.m;return this.logger.debug("[getAllAvailableCoupons] Got data from cache :",{response:c}),setTimeout(()=>{t.emit(c)}),t}{const n=this.settingsManager.getCouponingSorting(e,o),l=this.settingsManager.getDaysUntilStart(e),c=this.settingsManager.getSectionsSubsectionsIds(e,o);return this.geolocator.getCurrentPosition().pipe(Object(r.a)(t=>this.couponingApi.getAllAvailableCoupons(this.authService.authenticatedUser,n,i,l,t,c)),Object(a.a)(t=>this.couponingApi.getAllAvailableCoupons(this.authService.authenticatedUser,n,i,l,null,c)),Object(s.a)(e=>{if(this.logger.debug("Response received :",{response:e}),e.getString(t.ERROR))throw new Error;{let o=e.getArray(t.RESULT).map(t=>{let e=this.itemFactory.createCoupon(new u.JsonObject(t));return this.setCachedData(`coupon-${e.id}`,e),e}),n=e.getNumber(t.NEXT_PAGE),r=new u.GBCouponContainer(o,n);return 1===i?this.setCachedData(g,r):this.mergeCachedData(g,r),r}}))}}getCachedData(e){if(t._cache.has(e))return t._cache.get(e)}setCachedData(e,o){this.platform.isBrowser&&(!this.platform.isIOS||!this.platform.isStandaloneMode)&&t._cache.set(e,o)}mergeCachedData(e,o){let n;t._cache.has(e)&&((n=t._cache.get(e)).coupons.push(...o.coupons),n.nextPage=o.nextPage)}}return t.RESULT="result",t.ERROR="err",t.NEXT_PAGE="next_page",t._cache=new Map,t.ngInjectableDef=n.Rb({factory:function(){return new t(n.Sb(l.a),n.Sb(m),n.Sb(v.a),n.Sb(w.a),n.Sb(b.a),n.Sb(T.a),n.Sb(y.a))},token:t,providedIn:"root"}),t})()}}]);