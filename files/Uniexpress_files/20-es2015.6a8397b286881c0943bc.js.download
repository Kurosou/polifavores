(window.webpackJsonp=window.webpackJsonp||[]).push([[20],{Mxqu:function(e,t,s){"use strict";var a=s("8Y7J"),r=s("RoMp"),n=s("7jrj"),i=s("d788"),o=s("sQiW"),l=s("b/2F"),u=s("amjt"),h=s("+Np5"),d=s("yQCy"),g=s("Gj0x"),c=s("ZDlw"),b=s("ERS/"),m=s("cUpR"),p=s("t+st"),f=s("PHIT"),I=s("Qqk8"),S=s("otht"),T=s("QQfA"),A=s("5UkR"),w=s("ixKM"),y=s("ZrWq"),M=s("gR/Y"),O=s("vyNy"),v=s("v4z3"),C=s("NHof"),k=s("6ojV"),U=s("xMK7"),j=s("chYT"),_=s("vrt3"),E=s("iamH"),x=s("/Lhg"),N=s("SVse"),P=s("aTfN"),L=s("dbrL"),B=s("cDvF"),J=s("iInd"),F=s("2esf");s("NgrL"),s.d(t,"a",(function(){return R})),s.d(t,"b",(function(){return z}));var R=a.pb({encapsulation:0,styles:[["[_nghost-%COMP%]{display:flex;flex-direction:column}.content[_ngcontent-%COMP%]{flex:1 0 auto;position:relative;display:flex;flex-direction:column;z-index:0}gb-categories.bottom[_ngcontent-%COMP%]{position:fixed;bottom:0;width:100%;z-index:990}gb-categories.bottom.with-tabbar[_ngcontent-%COMP%]{bottom:66px;bottom:calc(66px + env(safe-area-inset-bottom))}.pager-space[_ngcontent-%COMP%]{display:block;height:48px;flex-shrink:0}@media only screen and (orientation:portrait) and (max-width:1024px),only screen and (orientation:landscape) and (max-width:1279px){.pager-space[_ngcontent-%COMP%]{height:40px}}@media screen and (-ms-high-contrast:active),screen and (-ms-high-contrast:none){[_nghost-%COMP%]{overflow:auto}}@media only screen and (orientation:portrait) and (max-width:599px),only screen and (orientation:landscape) and (max-width:959px){[_nghost-%COMP%]:not(.with-tabbar):not(.full-height){padding-bottom:env(safe-area-inset-bottom)}}"]],data:{}});function q(e){return a.Nb(0,[(e()(),a.rb(0,0,null,null,8,"gb-navbar",[],null,null,null,r.b,r.a)),a.qb(1,770048,[["navbar",4]],3,n.a,[a.k,i.a,o.a,l.a,u.a,h.a],{node:[0,"node"],sectionId:[1,"sectionId"],disableHideEffect:[2,"disableHideEffect"],largestTemplate:[3,"largestTemplate"]},null),a.Jb(603979776,1,{menuButton:0}),a.Jb(603979776,2,{backButton:0}),a.Jb(603979776,3,{navbarTitle:0}),(e()(),a.rb(5,0,null,1,1,"gb-navbar-title",[],[[2,"align-left",null],[2,"item-title-displayed",null]],null,null,d.b,d.a)),a.qb(6,573440,[[3,4]],0,g.a,[a.k,c.a,o.a,b.a,m.j],{node:[0,"node"],sectionId:[1,"sectionId"]},null),(e()(),a.rb(7,0,null,6,1,"gb-navbar-shortcuts",[],null,null,null,p.b,p.a)),a.qb(8,245760,null,0,f.a,[l.a,I.a,S.a,T.c,o.a],null,null)],(function(e,t){var s=t.component;e(t,1,0,s.nodeType,s.sectionId,s.disableNavbarHideEffect,s.largestNavbarTemplate),e(t,6,0,s.nodeType,s.sectionId),e(t,8,0)}),(function(e,t){e(t,5,0,a.Db(t,6).horizontalAlignLeft,a.Db(t,6).isItemTitle)}))}function $(e){return a.Nb(0,[(e()(),a.rb(0,0,null,null,2,"gb-root-tabbar-main",[["gbStickTo","navbar"]],[[4,"height","px"]],[["window","resize"]],(function(e,t,s){var r=!0;return"window:resize"===t&&(r=!1!==a.Db(e,1).updateStick()&&r),r}),A.b,A.a)),a.qb(1,4866048,null,0,w.a,[a.k,c.a,a.D,l.a,y.a],{stickTo:[0,"stickTo"]},null),a.qb(2,245760,[[5,4]],0,M.a,[l.a,h.a,O.a],null,null)],(function(e,t){e(t,1,0,"navbar"),e(t,2,0)}),(function(e,t){e(t,0,0,a.Db(t,2).height)}))}function H(e){return a.Nb(0,[(e()(),a.rb(0,0,null,null,1,"gb-categories",[],null,null,null,v.b,v.a)),a.qb(1,573440,[[4,4]],0,C.a,[k.a],{sectionId:[0,"sectionId"],category:[1,"category"]},null)],(function(e,t){var s=t.component;e(t,1,0,s.sectionId,s.subsectionIndex)}),null)}function G(e){return a.Nb(0,[(e()(),a.rb(0,0,null,null,3,null,null,null,null,null,null,null)),(e()(),a.rb(1,0,null,null,1,"gb-categories",[["class","bottom"]],[[2,"with-tabbar",null]],null,null,v.b,v.a)),a.qb(2,573440,null,0,C.a,[k.a],{sectionId:[0,"sectionId"],category:[1,"category"]},null),(e()(),a.rb(3,0,null,null,0,"div",[["class","pager-space"]],null,null,null,null,null))],(function(e,t){var s=t.component;e(t,2,0,s.sectionId,s.subsectionIndex)}),(function(e,t){e(t,1,0,t.component.rootService.tabBarBottomIsVisible)}))}function K(e){return a.Nb(0,[(e()(),a.rb(0,0,null,null,1,"gb-root-tabbar-main",[],[[4,"height","px"]],null,null,A.b,A.a)),a.qb(1,245760,null,0,M.a,[l.a,h.a,O.a],null,null)],(function(e,t){e(t,1,0)}),(function(e,t){e(t,0,0,a.Db(t,1).height)}))}function z(e){return a.Nb(0,[(e()(),a.rb(0,0,null,null,2,"gb-background-image-switcher",[["class","fixed"]],[[4,"background-image",null],[8,"id",0]],null,null,U.b,U.a)),a.qb(1,540672,null,0,j.a,[m.c],{gradient:[0,"gradient"]},null),a.qb(2,49152,null,0,_.a,[l.a],{mobile:[0,"mobile"],portrait:[1,"portrait"],landscape:[2,"landscape"]},null),(e()(),a.rb(3,0,null,null,12,"gb-header",[],null,null,null,E.b,E.a)),a.qb(4,180224,null,0,x.a,[c.a],null,null),(e()(),a.hb(16777216,null,0,1,null,q)),a.qb(6,16384,null,0,N.k,[a.O,a.L],{ngIf:[0,"ngIf"]},null),a.Cb(0,0),(e()(),a.rb(8,0,null,0,7,"gb-header-navigation",[],null,null,null,P.b,P.a)),a.qb(9,4440064,null,2,L.a,[a.k,h.a,u.a,l.a],null,null),a.Jb(603979776,4,{categories:0}),a.Jb(603979776,5,{tabbar:0}),(e()(),a.hb(16777216,null,0,1,null,$)),a.qb(13,16384,null,0,N.k,[a.O,a.L],{ngIf:[0,"ngIf"]},null),(e()(),a.hb(16777216,null,1,1,null,H)),a.qb(15,16384,null,0,N.k,[a.O,a.L],{ngIf:[0,"ngIf"]},null),(e()(),a.rb(16,0,null,null,2,"div",[["class","content"],["gbCategoriesSwipe",""]],null,[[null,"swipeleft"],[null,"swiperight"]],(function(e,t,s){var r=!0;return"swipeleft"===t&&(r=!1!==a.Db(e,17).onSwipeLeft()&&r),"swiperight"===t&&(r=!1!==a.Db(e,17).onSwipeRight()&&r),r}),null,null)),a.qb(17,540672,null,0,B.a,[k.a,J.p,b.a,F.a],{currentIndex:[0,"currentIndex"],sectionId:[1,"sectionId"],swipeEnabled:[2,"swipeEnabled"]},null),a.Cb(null,1),(e()(),a.hb(16777216,null,null,1,null,G)),a.qb(20,16384,null,0,N.k,[a.O,a.L],{ngIf:[0,"ngIf"]},null),(e()(),a.hb(16777216,null,null,1,null,K)),a.qb(22,16384,null,0,N.k,[a.O,a.L],{ngIf:[0,"ngIf"]},null)],(function(e,t){var s=t.component;e(t,1,0,s.useGradient?s.backgroundColorGradient:null),e(t,2,0,s.useGradient?null:null==s.effectBackgroundImage?null:s.effectBackgroundImage.imageUrl,s.useGradient?null:null==s.backgroundImagePortrait?null:s.backgroundImagePortrait.imageUrl,s.useGradient?null:null==s.backgroundImageLandscape?null:s.backgroundImageLandscape.imageUrl),e(t,6,0,!1===s.customNavbar&&!s.navbar),e(t,9,0),e(t,13,0,s.rootService.tabBarTopIsVisible),e(t,15,0,s.displayCategory&&!s.displayCategoryAfterContent),e(t,17,0,s.subsectionIndex,s.sectionId,!s.disableCategories),e(t,20,0,s.displayCategory&&s.displayCategoryAfterContent),e(t,22,0,s.rootService.tabBarBottomIsVisible)}),(function(e,t){e(t,0,0,a.Db(t,1).gradientStyle,a.Db(t,2).id)}))}},NgrL:function(e,t,s){"use strict";s.d(t,"a",(function(){return i}));var a=s("mrSG"),r=s("M0ag"),n=s("iwHP");let i=(()=>{class e{constructor(e,t,s,a,n){this.platform=e,this.rootService=t,this.header=s,this.settingsManager=a,this.sanitizer=n,this.subsectionIndex=-1,this.customNavbar=!1,this.nodeType=r.NodeType.List,this.header.reset()}get hasBottomTabBar(){return this.rootService.tabBarBottomIsVisible}get navbarHide(){return this.header.navbarEffectHide}get height(){return this.sanitizer.bypassSecurityTrustStyle(`calc(100% + ${this.header.bigNavBarSize}px)`)}get platformBackgroundImage(){return this.platform.isMobileSize()?this.effectBackgroundImage:this.platform.isPortrait?this.backgroundImagePortrait:this.backgroundImageLandscape}get useGradient(){return Object(r.useGradientInsteadOfBackgroundImage)(this.backgroundColorGradient,this.platformBackgroundImage)}ngOnChanges(e){"GBModuleTypeHome"===this.settingsManager.getSectionsType(this.sectionId)&&(this.nodeType=r.NodeType.General);const t=this.settingsManager.getSectionsSubsectionsCount(this.sectionId);this.displayCategory=t>1&&!this.disableCategories&&-1!==this.subsectionIndex;const s=this.settingsManager.getSectionsCategoriesTemplateType(this.sectionId);this.displayCategoryAfterContent=s===r.CategoryTemplateType.Pager,this.disableNavbarHideEffect=this.hasTabs||this.displayCategory&&(s===r.CategoryTemplateType.CircleBand||s===r.CategoryTemplateType.Dropdown),this.backgroundColor=this.settingsManager.getSectionsBackgroundColor(this.sectionId),this.backgroundColorGradient=this.settingsManager.getSectionsBackgroundColorGradient(this.sectionId),this.effectBackgroundImage=this.settingsManager.getSectionsEffectBackgroundImage(this.sectionId),this.backgroundImagePortrait=this.settingsManager.getSectionsBackgroundImagePortrait(this.sectionId),this.backgroundImageLandscape=this.settingsManager.getSectionsBackgroundImageLandscape(this.sectionId)}}return a.b([Object(n.a)("sections")],e.prototype,"ngOnChanges",null),e})()},P8Qj:function(e,t,s){"use strict";var a=s("jtHE"),r=s("quSY"),n=s("PqYM"),i=s("z6cu"),o=s("LRne"),l=s("eIep"),u=s("XNiG"),h=s("oB13"),d=s("lJxs"),g=s("JIr8"),c=s("bOdf"),b=s("M0ag"),m=s("8Y7J"),p=s("wd/R"),f=s("IheW");let I=(()=>{class e{constructor(t){t&&(t instanceof f.j?(this.json=new b.JsonObject(t.body),t.headers.has(e.NEXT_PAGE)&&(this.nextPage=t.headers.get(e.NEXT_PAGE)),t.headers.has(e.TOTAL_COUNT)&&(this.totalCount=Number.parseInt(t.headers.get(e.TOTAL_COUNT)))):t instanceof b.JsonObject&&(this.json=t))}}return e.NEXT_PAGE="X-Next-Page",e.TOTAL_COUNT="X-Total-Count",e})();const S={blacklist:["3"],stat:"ok",items:[{1:{itemId:1,other_user:"1","last-readed":{123456789:5,hide_for:[]},last_message:{id:6,message:"CHAT_FAKE_7",date:p().hour(10).minute(50).toJSON(),from:"1"}}},{2:{itemId:2,other_user:"2","last-readed":{123456789:6,hide_for:[]},last_message:{id:6,from:"2",message:"CHAT_FAKE_14",date:p().hour(10).minute(10).toJSON()}}},{3:{itemId:3,other_user:"3","last-readed":{123456789:1,hide_for:[]},last_message:{id:1,from:"3",message:"CHAT_FAKE_15",date:p().subtract(9,"days").toJSON()}}}]},T={stat:"ok",items:{123456789:{urlPhoto:"[BASE_URL]/assets/img/gbpreview/chatAvatarPlaceholder1.jpg",name:"User Name",userId:123456789,displayName:"User Name"},1:{urlPhoto:"[BASE_URL]/assets/img/gbpreview/chatAvatarPlaceholder4.jpg",name:"Paul",userId:1,displayName:"Paul"},2:{urlPhoto:"[BASE_URL]/assets/img/gbpreview/chatAvatarPlaceholder3.jpg",name:"George",userId:2,displayName:"George"},3:{urlPhoto:"[BASE_URL]/assets/img/gbpreview/chatAvatarPlaceholder2.jpg",name:"John",userId:3,displayName:"John"}}},A=p().subtract(1,"days").hour(14).minute(7),w=p().subtract(1,"days").hour(17).minute(43),y={stat:"ok",1:{messages:[{id:0,from:"1",date:A.toJSON(),message:"CHAT_FAKE_1"},{id:1,from:"123456789",date:A.add(4,"minute").toJSON(),message:"CHAT_FAKE_2"},{id:2,from:"1",date:A.add(2,"minute").toJSON(),message:"CHAT_FAKE_3"},{id:3,from:"123456789",date:p().hour(10).minute(14).toJSON(),message:"CHAT_FAKE_4"},{id:4,from:"1",date:p().hour(10).minute(42).toJSON(),message:"CHAT_FAKE_5"},{id:5,from:"123456789",date:p().hour(10).minute(43).toJSON(),message:"CHAT_FAKE_6"},{id:6,from:"1",date:p().hour(10).minute(50).toJSON(),message:"CHAT_FAKE_7"}]},2:{messages:[{id:7,from:"2",date:w.toJSON(),message:"CHAT_FAKE_8"},{id:8,from:"123456789",date:w.add(4,"minute").toJSON(),message:"CHAT_FAKE_9"},{id:9,from:"2",date:w.add(4,"minute").toJSON(),message:"CHAT_FAKE_10"},{id:10,from:"123456789",date:w.add(1,"minute").toJSON(),message:"CHAT_FAKE_11"},{id:11,from:"2",date:w.add(3,"minute").toJSON(),message:"CHAT_FAKE_12"},{id:12,from:"123456789",date:w.add(2,"minute").toJSON(),message:"CHAT_FAKE_13"},{id:13,from:"2",date:p().hour(10).minute(10).toJSON(),message:"CHAT_FAKE_14"}]},3:{messages:[{id:14,from:"3",date:p().subtract(9,"days").toJSON(),message:"CHAT_FAKE_15"}]}};class M{constructor(e,t){this.settingsManager=e,this.languagesManager=t}blockUser(e){throw new Error("not implemented")}deleteThread(e){throw new Error("not implemented")}getAuthToken(){throw new Error("not implemented")}getItemsByUrl(e){throw new Error("not implemented")}getMessages(e){const t=JSON.parse(JSON.stringify(y[e.id]||y[1]));for(const s in t.messages)t.messages[s].message&&t.messages[s].message.startsWith("CHAT_FAKE")&&(t.messages[s].message=this.languagesManager.getLanguageByKey(`GB_TXT_${t.messages[s].message}`));return Object(o.a)(new I(new b.JsonObject(t)))}getThreads(){const e=Object.assign({},S);for(const t of e.items)for(const e in t)t[e].last_message&&(t[e].last_message.message=this.languagesManager.getLanguageByKey(t[e].last_message.message));return Object(o.a)(new I(new b.JsonObject(e)))}markThreadAsRead(e){throw new Error("not implemented")}postMessage(e){throw new Error("not implemented")}userListProxy(e){const t=this.settingsManager.getMostAccurateBaseUrl();for(const s in T.items)T.items[s].urlPhoto&&(T.items[s].urlPhoto=T.items[s].urlPhoto.replace("[BASE_URL]",t));return Object(o.a)(new I(new b.JsonObject(T)))}reportSpam(e){throw new Error("not implemented")}}var O=s("pLZG");const v=60;let C=(()=>{class e{constructor(e,t,s,a){this.authService=e,this.settingsManager=t,this.http=s,this.logger=a,this.retryCount=0,this.setDefaultBaseUrl(),this.idWebzine=this.settingsManager.getIdWebzine(),this.authService.loggedIn.pipe(Object(O.a)(e=>!0===e)).subscribe(()=>{this.currentUser=this.authService.authenticatedUser,this.token=null})}blockUser(e){const t=`${this.baseUrl}/blacklist/${this.idWebzine}/${this.currentUser.unformattedId}/`;let s=(new f.i).set("iduser",e.unformattedId);return this.request(t,"post",s)}deleteThread(e){const t=`${this.baseUrl}/openChatList/${this.idWebzine}/${this.currentUser.unformattedId}/`;let s=(new f.i).set("iduser",e.user.unformattedId);return this.request(t,"post",s)}getAuthToken(){const e=`${this.baseUrl}/authToken/${this.idWebzine}/`;let t=new f.i({encoder:new b.AuthTokenQueryEncoder});t=t.set("credentials",`${this.currentUser.login}:${this.currentUser.pwd}`);let s=new f.h;return s=s.append("Content-Type","application/x-www-form-urlencoded"),this.http.post(e,t.toString(),{headers:s}).pipe(Object(d.a)(e=>(this.logger.debug("Chat API Service response",e),new b.JsonObject(e))),Object(g.a)(e=>(this.logger.error("Chat API Service response",e),Object(i.a)("Chat API service getAuthToken error"))))}getItemsByUrl(e){return this.request(e,"get")}getMessages(e){return this.request(`${this.baseUrl}/oneToOne/${this.idWebzine}/${this.currentUser.unformattedId}/${e.userId}/1/${v}/`,"get")}getThreads(){return this.request(`${this.baseUrl}/openChatList/${this.idWebzine}/${this.currentUser.unformattedId}/`,"get")}markThreadAsRead(e){return this.request(`${this.baseUrl}/oneToOne/${this.idWebzine}/${this.currentUser.unformattedId}/${e.userId}/1/${v}/`,"get")}postMessage(e){const t=`${this.baseUrl}/oneToOne/${this.idWebzine}/${this.currentUser.unformattedId}/`+`${e.otherUser.unformattedId}/1/${v}/`;let s=(new f.i).set("message",e.message);return this.request(t,"post",s)}userListProxy(e){const t=`${this.baseUrl}/userListProxy/${e.join("/")}/`;return this.request(t,"get")}reportSpam(e){const t=`${this.baseUrl}/spamList/${this.idWebzine}/${e.userId}/`,s=(new f.i).set("iduser",this.authService.authenticatedUser.unformattedId);return this.request(t,"post",s)}getAuthTokenForRequest(){return this.token?Object(o.a)(this.token):this.getAuthToken().pipe(Object(d.a)(t=>{let s=t.getJsonObject(e.ITEM).getString(e.VALUE);return this.token=s,s}))}request(e,t,s=null){return this.getAuthTokenForRequest().pipe(Object(c.a)(a=>{let r=new f.h,n={headers:r=r.append("X-User-Token",a),responseType:"json",observe:"response"};return"post"===t?(r=r.append("Content-Type","application/x-www-form-urlencoded"),n.body=s||null):n.params=s?s.toString():"",this.http.request(t,e,n).pipe(Object(d.a)(e=>(this.logger.debug("Chat API Service response",e.body),new I(e))),Object(g.a)(a=>(this.logger.error("Chat API Service response",a),401===a.status&&this.retryCount<3?(this.token=null,this.retryCount++,this.request(e,t,s)):Object(i.a)("Chat API Service request error"))))}))}setDefaultBaseUrl(){this.baseUrl=e.BASEURL,this.logger.info(`Couponing Api Base Url: ${this.baseUrl}`)}}return e.BASEURL="https://chat.good-api.net",e.ITEM="item",e.VALUE="value",e})();var k=s("Iurr"),U=s("jGGy"),j=s("otht"),_=s("I2LU"),E=s("6ojV");let x=(()=>{class e{}return e.ngInjectableDef=m.Rb({factory:function(){return e=m.Sb(k.c),t=m.Sb(U.a),s=m.Sb(f.c),a=m.Sb(j.a),r=m.Sb(_.a),n=m.Sb(E.a),e.mockData?new M(n,a):new C(t,n,s,r);var e,t,s,a,r,n},token:e,providedIn:"root"}),e})();var N=s("0Bcz");s.d(t,"a",(function(){return P}));let P=(()=>{class e{constructor(e,t,s){this.apiService=e,this.authService=t,this.itemFactory=s,this.lastThreads=new a.a(1),this.lastMessages=new a.a(1),this.allMessages=new a.a(1),this.newMessages=new a.a(1),this.messagesSubscription=new r.a,this.threadsHaveLoaded=!1,this.deletedUsers=new Set,this.markedAsRead=new Map,this.messages=new Map,this.messagesForThread=new Map,this.threads=new Map,this.userIds=new Map,this.users=new Map,this.unreadMessages=new Map}blockUser(e){this.apiService.blockUser(e).subscribe()}clearCache(){this.deletedUsers.clear(),this.markedAsRead.clear(),this.messages.clear(),this.messagesForThread.clear(),this.threads.clear(),this.userIds.clear(),this.users.clear(),this.unreadMessages.clear(),this.lastThreads.complete(),this.allMessages.complete(),this.newMessages.complete(),this.lastThreads=new a.a(1),this.allMessages=new a.a(1),this.newMessages=new a.a(1)}deleteThread(e){this.apiService.deleteThread(e).subscribe()}fetchNextThreads(){return this.getThreadsWithUserInfos(this.nextPage)}threadsWithInterval(e){return Object(n.a)(0,e).pipe(Object(l.a)(()=>this.getThreadsWithUserInfos()))}fetchMessagesByUrl(e,t){this.getMessages(e,t).subscribe(e=>{this.lastMessages.next(e)})}messagesByUrl(e,t){return this.getMessages(e,t)}fetchMessagesWithInterval(e,t){return this.messagesSubscription.unsubscribe(),this.messagesFetcher=Object(n.a)(0,t).pipe(Object(l.a)(()=>this.getMessages(e)),Object(h.a)(new u.a)),this.messagesFetcher.subscribe(this.lastMessages),this.messagesSubscription=this.messagesFetcher.connect(),this.messagesFetcher}getThreadForUser(e){return this.threads.get(e.unformattedId)}markThreadAsRead(e){this.markedAsRead.get(e.id)!==e.lastMessage.id&&(this.markedAsRead.set(e.id,e.lastMessage.id),this.apiService.markThreadAsRead(e).subscribe(),this.removeUnreadThreadMessages(e))}postMessage(t){return this.messagesSubscription.unsubscribe(),this.apiService.postMessage(t).pipe(Object(l.a)(t=>{let s=t.json.getJsonObject(e.LAST_READ).getString(this.authService.authenticatedUser.unformattedId);return this.messagesSubscription=this.messagesFetcher.connect(),[s]}))}userHasThread(e){return this.threads.has(e.unformattedId)}reportSpam(e){return this.apiService.reportSpam(e)}removeUnreadThreadMessages(e,t=!0){this.unreadMessages.get(e.id)&&(this.unreadMessages.delete(e.id),t&&this.newMessages.next(this.unreadMessages))}getMessagesApiResponse(e,t){return t?this.apiService.getItemsByUrl(t):this.apiService.getMessages(e)}getMessagesWithCache(t,s){return t.lastMessage&&this.markedAsRead.set(t.id,t.lastMessage.id),this.getMessagesApiResponse(t,s).pipe(Object(d.a)(a=>{let r=new Array;return a.json.getArray(e.MESSAGES).forEach(s=>{let a,n=new b.JsonObject(s),o=n.getString(e.MESSAGE_ID);if(this.messages.has(o))a=this.messages.get(o);else{(a=this.itemFactory.createChatMessage(n)).otherUser=t.user;let s=n.getString(e.FROM);if(s===this.authService.authenticatedUser.unformattedId)a.author=this.authService.authenticatedUser;else if(this.users.has(s))a.author=this.users.get(s);else{if(!t.user)throw Object(i.a)("Message author not found");a.author=t.user}this.messages.set(o,a);let r=this.messagesForThread.get(t.id);r||(this.messagesForThread.set(t.id,new Array),r=this.messagesForThread.get(t.id)),r.push(a)}r.push(a)}),t.nextPage?s&&(t.nextPage=a.nextPage,t.currentCount+=r.length):(t.nextPage=a.nextPage,t.totalCount=a.totalCount,t.currentCount=r.length),this.allMessages.next(Array.from(this.messages.values())),r}),Object(g.a)(()=>{let e=this.messagesForThread.get(t.id);return e?Object(o.a)(e):Object(o.a)([])}))}getMessages(e,t){return this.getMessagesWithCache(e,t).pipe(Object(d.a)(t=>{let s=new Array;return this.messages.forEach(t=>{t.otherUser===e.user&&s.push(t)}),s}))}getThreadsApiResponse(e){return e?this.apiService.getItemsByUrl(e):this.apiService.getThreads()}getThreadList(t){return this.getThreadsApiResponse(t).pipe(Object(d.a)(s=>{let a=s.json.getArray(e.BLACKLIST),r=new Array;return s.json.getArray(e.ITEMS).forEach(t=>{let s=Object.keys(t),n=new b.JsonObject(t[s[0]]),i=n.getJsonObject(e.LAST_MESSAGE),o=this.itemFactory.createChatMessage(i),l=this.itemFactory.createChatThread(n);l.lastMessage=o;let u=l.userId;if(a.includes(l.userId)&&(l.isBlocked=!0),l.lastMessage.authorId!==this.authService.authenticatedUser.unformattedId){let e,t;e=this.markedAsRead.has(l.id)?this.markedAsRead.get(l.id):l.lastRead.getString(this.authService.authenticatedUser.unformattedId),l.isNew=e!==l.lastMessage.id,this.unreadMessages.has(l.id)?(t=this.unreadMessages.get(l.id)).has(o.id)||o.id===e||t.add(o.id):(t=new Set).add(o.id),this.unreadMessages.set(l.id,t),l.isNew||this.removeUnreadThreadMessages(l,!1)}this.deletedUsers.has(u)||(this.users.has(u)?l.user=this.users.get(u):this.userIds.set(u,l.id),this.threads.set(u,l),r.push(l))}),s.nextPage?!t&&this.nextPage||(this.nextPage=s.nextPage):this.threadsHaveLoaded=!0,this.newMessages.next(this.unreadMessages),r}),Object(g.a)(()=>{let e=this.threads;return e?Object(o.a)(Array.from(e.values())):Object(o.a)([])}))}getThreadsWithUserInfos(e){return this.getThreadList(e).pipe(Object(c.a)(e=>{let t=Array.from(this.userIds.keys());return 0===t.length?Object(o.a)(e):this.getUserInfos(t).pipe(Object(d.a)(e=>(e.forEach(e=>{this.threads.has(e.unformattedId)&&(this.threads.get(e.unformattedId).user=e)}),this.userIds.clear(),Array.from(this.threads.values()))))}),Object(d.a)(e=>e.filter(e=>null!==e.user)))}getUserInfos(t){return this.apiService.userListProxy(t).pipe(Object(d.a)(s=>{let a=new Array,r=s.json.getJsonObject(e.ITEMS);return t.forEach(e=>{let t=r.getJsonObject(e);if(t){let s=this.itemFactory.createUser(t);this.users.set(e,s),a.push(s)}else this.deletedUsers.add(e)}),a}))}}return e.BLACKLIST="blacklist",e.FROM="from",e.LAST_READ="last-readed",e.LAST_MESSAGE="last_message",e.MESSAGE_ID="id",e.ITEMS="items",e.MESSAGES="messages",e.ngInjectableDef=m.Rb({factory:function(){return new e(m.Sb(x),m.Sb(U.a),m.Sb(N.a))},token:e,providedIn:"root"}),e})()}}]);